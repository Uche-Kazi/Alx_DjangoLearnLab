{% extends "blog/base.html" %}
{% load blog_tags %}
{% load static %}

{% block title %}{{ post.title }}{% endblock %}

{% block content %}
    <h1>{{ post.title }}</h1>
    <p class="date">
        Published {{ post.publish|date:"F j, Y" }} by {{ post.author }}
    </p>
    {{ post.body|markdown }}

    {# Display a message if available #}
    {% if messages %}
        <ul class="messages">
            {% for message in messages %}
                <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>
                    {{ message }}
                </li>
            {% endfor %}
        </ul>
    {% endif %}

    <p>
        <a href="{% url 'blog:post_share' post.id %}">
            Share this post
        </a>
    </p>

    <h2>Similar posts</h2>
    {% for post in similar_posts %}
        <p>
            <a href="{{ post.get_absolute_url }}">{{ post.title }}</a>
        </p>
    {% empty %}
        There are no similar posts yet.
    {% endfor %}

    {# --- Comments Section --- #}
    <div id="comments-section">
        <h2>{{ comments.count }} comment{{ comments.count|pluralize }}</h2>

        {% for comment in comments %}
            <div class="comment" id="comment-{{ comment.pk }}">
                <p class="info">
                    <strong>{{ comment.author.username }}</strong> commented
                    {{ comment.created_at|timesince }} ago
                    {% if comment.author == request.user %}
                        {# Only show edit/delete links if the logged-in user is the comment author #}
                        <span class="comment-actions">
                            | <a href="{% url 'blog:edit_comment' comment.pk %}">Edit</a>
                            | <a href="{% url 'blog:delete_comment' comment.pk %}">Delete</a>
                        </span>
                    {% endif %}
                </p>
                {{ comment.content|linebreaks }} {# Display content with line breaks #}
            </div>
        {% empty %}
            <p>There are no comments yet.</p>
        {% endfor %}

        {# --- Comment Form --- #}
        {% if user.is_authenticated %}
            <h3>Add a new comment</h3>
            <form action="{{ post.get_absolute_url }}" method="post">
                {{ comment_form.as_p }}
                {% csrf_token %}
                <p><input type="submit" value="Add comment"></p>
            </form>
        {% else %}
            <p>
                {# Corrected login URL for allauth #}
                <a href="{% url 'account_login' %}?next={{ request.path }}">Log in</a> to post a comment.
            </p>
        {% endif %}
    </div>

{% endblock %}
